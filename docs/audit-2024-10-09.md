# VOIDE Repository Audit — 2024-10-09

## Commands Executed

- `pnpm install`
  - Completes but reports multiple Vitest peer dependency mismatches across packages. 【0a8246†L1-L27】
- `pnpm test`
  - Fails on a clean checkout because `@voide/main` tests cannot resolve the `@voide/shared/flowValidation` export before it has been built. 【da315c†L1-L27】
- `pnpm --filter @voide/shared build`
  - Produces the missing `dist/` artifacts required by `@voide/main`. 【802ea4†L1-L3】
- `pnpm test` (rerun after building shared)
  - Succeeds end-to-end, confirming the failure above is due solely to the missing build artefacts. 【406b7c†L1-L24】【6dabbe†L1-L3】【712934†L1-L12】
- `pnpm --filter @voide/renderer build`
  - Fails because the renderer bundles a Node-only dependency path that calls `createRequire` from `node:module`. 【f4dcfd†L1-L27】
- `pnpm dev`
  - Aborts for the same reason as the standalone renderer build, so the desktop app cannot launch. 【e70a5c†L1-L30】

## Findings & Actionable Tasks

### 1. Renderer build/dev blocked by Node-only flow validation helper

- Evidence:
  - `packages/shared/src/flowValidation.ts` imports `createRequire` from `node:module` and uses it to synchronously load the JSON schema. 【F:packages/shared/src/flowValidation.ts†L1-L21】
  - The compiled `dist/flowValidation.js` retains that Node-specific logic, which Vite attempts to include in the browser bundle. 【F:packages/shared/dist/flowValidation.js†L1-L24】
  - The renderer consumes this helper directly (`@voide/shared/flowValidation`) for in-canvas validation. 【F:packages/renderer/src/voide.ts†L1-L33】【F:packages/renderer/src/state/flowStore.ts†L1-L40】
  - Vite fails the build because `createRequire` is unavailable in the browser runtime, which also breaks `pnpm dev`. 【f4dcfd†L1-L27】【e70a5c†L1-L30】
- Impact: Renderer production builds and the Electron dev workflow cannot run, blocking any front-end development or QA.
- Recommendation: Refactor `flowValidation` to avoid `createRequire`. Load the flow schema via ESM (e.g., `import flowSchema from "../../../flows/schema/flow.schema.json" assert { type: "json" };`) and guard Node-only helpers behind environment checks, or provide a browser-specific entry point for the renderer.

### 2. Test pipeline depends on unpublished `dist/` artefacts

- Evidence:
  - `packages/main/src/services/validate.ts` imports the `@voide/shared/flowValidation` export, which is routed to `dist/flowValidation.js` via the package exports map. 【F:packages/main/src/services/validate.ts†L1-L5】【F:packages/shared/package.json†L1-L20】
  - When `pnpm test` runs in a clean workspace, Node’s ESM loader (via `ts-node/esm`) fails because `packages/shared/dist/flowValidation.js` does not exist yet. 【da315c†L1-L27】
  - Manually running `pnpm --filter @voide/shared build` creates the expected dist files and allows the test suite to pass. 【802ea4†L1-L3】【406b7c†L1-L24】【6dabbe†L1-L3】【712934†L1-L12】
- Impact: Continuous integration or contributors who run `pnpm test` immediately after cloning hit deterministic failures unless they remember to build `@voide/shared` first.
- Recommendation: Ensure the shared package is built before tests. Options include: adding a pre-test `pnpm --filter @voide/shared build` step to the root `test` script, rewriting the tests to import the TypeScript source instead of the compiled output, or publishing the required `dist/` artefacts.

### 3. Mismatched Vitest versions across packages

- Evidence: `pnpm install` warns that several packages mix Vitest `1.x` with `@vitest/ui` `3.x`, and the renderer depends on Vitest `1.6.0` while the workspace root pulls `3.2.4`. 【0a8246†L1-L27】
- Impact: The workspace currently installs multiple copies of Vitest and its UI, increasing install size and risking incompatible CLI flags or config drift between packages.
- Recommendation: Align all workspace packages on a single Vitest release (preferably `3.x` to match the root) and update `@vitest/ui` accordingly so peer dependency resolution is clean.

